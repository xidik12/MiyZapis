// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String?
  passwordLastChanged DateTime?
  authProvider String? // "google", "telegram", "email" - tracks how user registered/authenticated
  firstName String
  lastName  String
  avatar    String?
  userType  String   @default("CUSTOMER") // "CUSTOMER", "SPECIALIST", "ADMIN"

  // Contact information
  phoneNumber String?
  telegramId  String? @unique

  // Platform settings
  isEmailVerified Boolean @default(false)
  isPhoneVerified Boolean @default(false)
  isActive        Boolean @default(true)
  lastLoginAt     DateTime?

  // Preferences
  language         String @default("en")
  currency         String @default("USD")
  timezone         String @default("UTC")

  // Notification preferences
  emailNotifications     Boolean @default(true)
  pushNotifications      Boolean @default(true)
  telegramNotifications  Boolean @default(true)

  // Loyalty program
  loyaltyPoints          Int     @default(0)

  // Wallet and Payment
  walletBalance          Float   @default(0.0)
  walletCurrency         String  @default("USD")

  // Specialist subscription
  subscriptionStatus     String  @default("PAY_PER_USE") // PAY_PER_USE, MONTHLY_SUBSCRIPTION
  subscriptionValidUntil DateTime?
  subscriptionEffectiveDate DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  specialist           Specialist?
  customerBookings     Booking[]               @relation("CustomerBookings")
  specialistBookings   Booking[]               @relation("SpecialistBookings")
  reviews              Review[]
  payments             Payment[]
  paymentMethods       PaymentMethod[]
  notifications        Notification[]
  loyaltyTransactions  LoyaltyTransaction[]
  
  // Enhanced Loyalty Relations
  loyaltyTier          LoyaltyTier? @relation("UserLoyaltyTier", fields: [loyaltyTierId], references: [id])
  loyaltyTierId        String?
  badges               UserBadge[]
  referralsGiven       LoyaltyReferral[] @relation("ReferrerRelation")
  referralsReceived    LoyaltyReferral[] @relation("ReferredRelation")
  campaignRedemptions  CampaignRedemption[]
  pointsRedemptions    PointsRedemption[]
  reviewRewards        ReviewReward[]
  refreshTokens        RefreshToken[]
  emailVerificationTokens EmailVerificationToken[]
  sentMessages         Message[]               @relation("SentMessages")
  receivedMessages     Message[]               @relation("ReceivedMessages")
  customerConversations Conversation[]         @relation("CustomerConversations")
  specialistConversations Conversation[]       @relation("SpecialistConversations")
  uploadedFiles        File[]
  reportsMade          Report[]                @relation("ReportsMade")
  reportsReceived      Report[]                @relation("ReportsReceived")
  favoriteSpecialists  FavoriteSpecialist[]    @relation("UserFavoriteSpecialists")
  favoriteServices     FavoriteService[]       @relation("UserFavoriteServices")
  profileViews         ProfileView[]           @relation("ProfileViewer")
  profileViewsReceived ProfileView[]           @relation("ProfileViewed")
  telegramSessions     TelegramSession[]
  createdRewards       LoyaltyReward[]         @relation("SpecialistRewards")
  rewardRedemptions    RewardRedemption[]      @relation("UserRewardRedemptions")
  walletTransactions   WalletTransaction[]
  cryptoPayments       CryptoPayment[]
  subscriptions        SpecialistSubscription[]
  onrampSessions       OnrampSession[]

  // Indexes for performance
  @@index([email])
  @@index([telegramId])
  @@index([userType, isActive])
  @@index([lastLoginAt])

  @@map("users")
}

model Specialist {
  id           String  @id @default(cuid())
  userId       String  @unique
  
  // Business profile
  businessName String?
  bio          String?
  bioUk        String? // Ukrainian bio
  bioRu        String? // Russian bio
  education    String? // Education background
  educationUk  String? // Ukrainian education
  educationRu  String? // Russian education
  
  // Professional details
  specialties  String // JSON string of specialty tags
  experience   Int      @default(0) // Years of experience
  isVerified   Boolean  @default(false)
  languages    String? // JSON string of supported languages
  
  // Location
  address      String?
  city         String?
  state        String?
  country      String?
  latitude     Float?
  longitude    Float?
  timezone     String   @default("UTC")
  workingHours String   // JSON string for working hours

  // Detailed contact information for confirmed bookings
  preciseAddress    String? // Exact address with apartment/suite number
  businessPhone     String? // Primary business phone number
  whatsappNumber    String? // WhatsApp contact number
  locationNotes     String? // Special instructions for finding the location
  parkingInfo       String? // Parking instructions
  accessInstructions String? // Building access, buzzer codes, etc.
  
  // Business operations
  paymentMethods String? // JSON string of accepted payment methods
  serviceArea    String? // JSON string for service area settings (radius, cities)
  notifications  String? // JSON string for notification preferences
  privacy        String? // JSON string for privacy settings
  socialMedia    String? // JSON string for social media profiles
  autoBooking    Boolean @default(false) // Auto-approve bookings without manual confirmation
  
  // Verification details
  verifiedDate   DateTime? // Date when verified
  documentsSubmitted String? // JSON string of submitted documents
  
  // Business metrics
  rating           Float   @default(0.0)
  reviewCount      Int     @default(0)
  completedBookings Int    @default(0)
  responseTime     Int     @default(0) // Average response time in minutes
  
  // Portfolio
  portfolioImages  String? // JSON string of image URLs
  certifications   String? // JSON string of certifications
  
  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user               User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  services           Service[]
  reviews            Review[]             @relation("SpecialistReviews")
  availabilityBlocks AvailabilityBlock[]
  analytics          SpecialistAnalytics[]
  favorites          FavoriteSpecialist[] @relation("SpecialistFavorites")

  // Indexes for performance
  @@index([city, isVerified])
  @@index([rating])
  @@index([specialties])
  @@index([isVerified])

  @@map("specialists")
}

model Service {
  id          String  @id @default(cuid())
  specialistId String
  categoryId  String?
  name        String
  description String
  category    String
  
  // Pricing
  basePrice      Float
  currency       String @default("USD")

  // Loyalty Points Pricing
  loyaltyPointsEnabled Boolean @default(false)
  loyaltyPointsPrice   Int?    // Points required to book this service
  loyaltyPointsOnly    Boolean @default(false) // If true, only bookable with points

  // Service Discounts
  discountEnabled      Boolean @default(false)
  discountType         String? // PERCENTAGE, FIXED_AMOUNT
  discountValue        Float?  // Percentage (0-100) or fixed amount
  discountValidFrom    DateTime?
  discountValidUntil   DateTime?
  discountDescription  String? // Optional description for the discount

  // Service details
  duration       Int    // Duration in minutes
  
  // Requirements and deliverables
  requirements  String // JSON string of requirements
  deliverables  String // JSON string of deliverables
  
  // Settings
  isActive         Boolean @default(true)
  requiresApproval Boolean @default(true)
  maxAdvanceBooking Int    @default(30) // Days
  minAdvanceBooking Int    @default(1)  // Hours
  
  // Soft deletion
  isDeleted        Boolean @default(false)
  deletedAt        DateTime?
  
  // Service images
  images String? // JSON string of image URLs
  
  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  specialist     Specialist @relation(fields: [specialistId], references: [id], onDelete: Cascade)
  categoryModel  Category?  @relation(fields: [categoryId], references: [id])
  bookings       Booking[]
  favorites      FavoriteService[] @relation("ServiceFavorites")

  // Indexes for performance
  @@index([categoryId, isActive, isDeleted])
  @@index([specialistId, isActive, isDeleted])
  @@index([basePrice])
  @@index([duration])
  @@index([isActive, isDeleted])
  @@index([isDeleted])

  @@map("services")
}

model Booking {
  id          String        @id @default(cuid())
  customerId  String
  specialistId String
  serviceId   String
  promoCodeId String?
  
  // Booking details
  status      String @default("PENDING") // PENDING, PENDING_PAYMENT, CONFIRMED, IN_PROGRESS, COMPLETED, CANCELLED, REFUNDED
  scheduledAt DateTime
  duration    Int           // Duration in minutes
  
  // Pricing
  totalAmount    Float
  depositAmount  Float
  remainingAmount Float
  loyaltyPointsUsed Int @default(0)
  paidWithLoyaltyPoints Boolean @default(false) // True if booking was paid entirely with loyalty points

  // Deposit payment tracking
  depositStatus        String @default("PENDING") // PENDING, PAID, REFUNDED, FORFEITED
  depositPaidAt        DateTime?
  depositRefundedAt    DateTime?
  depositCurrency      String @default("USD")
  walletAmountUsed     Float @default(0.0)
  
  // Additional information
  customerNotes    String?
  specialistNotes  String?
  preparationNotes String?
  completionNotes  String?
  deliverables     String // JSON string of deliverables
  
  // Time tracking
  confirmedAt   DateTime?
  startedAt     DateTime?
  completedAt   DateTime?
  cancelledAt   DateTime?
  
  // Cancellation details
  cancellationReason String?
  cancelledBy        String? // customerId or specialistId
  refundAmount       Float?
  
  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Indexes for performance
  @@index([status, scheduledAt])
  @@index([customerId, status])
  @@index([specialistId, status])
  @@index([scheduledAt])

  // Relations
  customer      User        @relation("CustomerBookings", fields: [customerId], references: [id])
  specialist    User        @relation("SpecialistBookings", fields: [specialistId], references: [id])
  service       Service     @relation(fields: [serviceId], references: [id])
  promoCode     PromoCode?  @relation(fields: [promoCodeId], references: [id])
  payments      Payment[]
  review        Review?
  notifications Notification[]
  conversations Conversation[]
  
  // Loyalty Relations
  pointsRedemptions PointsRedemption[]
  reviewRewards     ReviewReward[]
  rewardRedemptions RewardRedemption[] @relation("BookingRewardRedemptions")

  // Crypto Payment Relations
  cryptoPayments    CryptoPayment[]
  walletTransactions WalletTransaction[]
  onrampSessions    OnrampSession[]

  @@map("bookings")
}

model Payment {
  id        String        @id @default(cuid())
  userId    String
  bookingId String?

  // Payment details
  status    String  // PENDING, PROCESSING, SUCCEEDED, FAILED, CANCELLED, REFUNDED
  type      String  // DEPOSIT, FULL_PAYMENT, REFUND, LOYALTY_REDEMPTION, SUBSCRIPTION
  amount    Float
  currency  String  @default("USD")

  // External payment provider info
  stripePaymentIntentId String?
  stripeChargeId        String?

  // Payment method
  paymentMethodType String? // card, telegram_payment, crypto, wallet

  // Metadata
  metadata String? // JSON string
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user    User     @relation(fields: [userId], references: [id])
  booking Booking? @relation(fields: [bookingId], references: [id])

  @@map("payments")
}

model Review {
  id           String @id @default(cuid())
  bookingId    String @unique
  customerId   String
  specialistId String
  
  // Review content
  rating  Int    // 1-5 stars
  comment String?
  tags    String // JSON string of tags like "professional", "punctual", etc.
  
  // Review metadata
  isPublic Boolean @default(true)
  isVerified Boolean @default(false)
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  booking    Booking    @relation(fields: [bookingId], references: [id])
  customer   User       @relation(fields: [customerId], references: [id])
  specialist Specialist @relation("SpecialistReviews", fields: [specialistId], references: [id])

  @@map("reviews")
}

model LoyaltyTransaction {
  id     String                 @id @default(cuid())
  userId String
  
  // Transaction details
  type      String // EARNED, REDEEMED, EXPIRED, BONUS
  points    Int
  reason    String
  description String?
  
  // Transaction metadata
  referenceId String? // Reference to related booking, etc.
  expiresAt   DateTime?
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id])

  @@map("loyalty_transactions")
}

model Notification {
  id       String            @id @default(cuid())
  userId   String
  type     String // BOOKING_CREATED, BOOKING_CONFIRMED, etc.
  
  // Content
  title    String
  message  String
  data     String? // JSON string - Additional data for the notification
  
  // Status
  isRead   Boolean  @default(false)
  readAt   DateTime?
  
  // Delivery channels
  emailSent     Boolean @default(false)
  smsSent       Boolean @default(false)
  pushSent      Boolean @default(false)
  telegramSent  Boolean @default(false)
  
  // Optional booking reference
  bookingId String?
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user    User     @relation(fields: [userId], references: [id])
  booking Booking? @relation(fields: [bookingId], references: [id])

  @@map("notifications")
}

model AvailabilityBlock {
  id           String @id @default(cuid())
  specialistId String
  
  // Time block
  startDateTime DateTime
  endDateTime   DateTime
  
  // Block details
  isAvailable Boolean @default(true)
  reason      String? // Reason for unavailability
  
  // Recurring settings
  isRecurring     Boolean @default(false)
  recurringUntil  DateTime?
  recurringDays   String? // JSON string of days: ["monday", "tuesday"]
  
  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  specialist Specialist @relation(fields: [specialistId], references: [id], onDelete: Cascade)

  @@map("availability_blocks")
}

model RefreshToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  
  // Device info
  userAgent String?
  ipAddress String?
  
  // Status
  isRevoked Boolean @default(false)
  revokedAt DateTime?
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

model EmailVerificationToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  type      String   @default("EMAIL_VERIFICATION") // EMAIL_VERIFICATION, PASSWORD_RESET
  expiresAt DateTime
  
  // Status
  isUsed    Boolean @default(false)
  usedAt    DateTime?
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("email_verification_tokens")
}

model SpecialistAnalytics {
  id           String @id @default(cuid())
  specialistId String
  
  // Time period
  date    DateTime
  
  // Metrics
  bookingsCount     Int   @default(0)
  completedBookings Int   @default(0)
  cancelledBookings Int   @default(0)
  totalRevenue      Float @default(0.0)
  averageRating     Float @default(0.0)
  responseTimeAvg   Int   @default(0)
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  specialist Specialist @relation(fields: [specialistId], references: [id], onDelete: Cascade)

  @@unique([specialistId, date])
  @@map("specialist_analytics")
}

model SystemSettings {
  id    String @id @default(cuid())
  key   String @unique
  value String // JSON string
  
  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("system_settings")
}

model AuditLog {
  id        String @id @default(cuid())
  userId    String?
  entityType String  // Model name
  entityId  String  // Record ID
  action    String  // CREATE, UPDATE, DELETE
  
  // Details
  changes    String? // JSON string
  ipAddress  String?
  userAgent  String?
  
  // Timestamps
  createdAt DateTime @default(now())

  @@map("audit_logs")
}

model Category {
  id          String @id @default(cuid())
  name        String
  nameUk      String // Ukrainian translation
  nameRu      String // Russian translation
  description String?
  descriptionUk String?
  descriptionRu String?
  slug        String @unique
  icon        String?
  color       String?
  
  // Hierarchy
  parentId    String?
  parent      Category? @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryHierarchy")
  
  // Settings
  isActive    Boolean @default(true)
  sortOrder   Int     @default(0)
  
  // Metadata
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  services    Service[]

  @@map("categories")
}

model Message {
  id           String @id @default(cuid())
  conversationId String
  senderId     String
  receiverId   String
  
  // Content
  content      String
  messageType  String @default("TEXT") // TEXT, IMAGE, FILE, SYSTEM
  attachments  String? // JSON array of file URLs
  
  // Message status
  isRead       Boolean @default(false)
  readAt       DateTime?
  isDelivered  Boolean @default(false)
  deliveredAt  DateTime?
  
  // Metadata
  editedAt     DateTime?
  deletedAt    DateTime?
  
  // Timestamps
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  // Relations
  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User @relation("SentMessages", fields: [senderId], references: [id])
  receiver     User @relation("ReceivedMessages", fields: [receiverId], references: [id])

  @@map("messages")
}

model Conversation {
  id            String @id @default(cuid())
  
  // Participants
  customerId    String
  specialistId  String
  
  // Related booking (optional)
  bookingId     String?
  
  // Conversation status
  status        String @default("ACTIVE") // ACTIVE, ARCHIVED, BLOCKED
  
  // Last message info
  lastMessageAt DateTime?
  lastMessageContent String?
  
  // Unread counts
  customerUnreadCount    Int @default(0)
  specialistUnreadCount  Int @default(0)
  
  // Metadata
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relations
  customer      User @relation("CustomerConversations", fields: [customerId], references: [id])
  specialist    User @relation("SpecialistConversations", fields: [specialistId], references: [id])
  booking       Booking? @relation(fields: [bookingId], references: [id])
  messages      Message[]

  @@unique([customerId, specialistId, bookingId])
  @@map("conversations")
}

model File {
  id          String @id @default(cuid())
  filename    String
  originalName String
  mimeType    String
  size        Int
  path        String
  url         String
  
  // File metadata
  width       Int?
  height      Int?
  duration    Int? // For videos/audio in seconds
  
  // Upload info
  uploadedBy  String
  
  // File purpose
  purpose     String // AVATAR, SERVICE_IMAGE, MESSAGE_ATTACHMENT, PORTFOLIO, etc.
  entityType  String? // Model name this file belongs to
  entityId    String? // Record ID this file belongs to
  
  // Status
  isProcessed Boolean @default(false)
  isPublic    Boolean @default(false)
  
  // Cloud storage fields
  cloudProvider String? // 'S3', 'CLOUDINARY', 'LOCAL', etc.
  cloudKey      String? // Key/path in cloud storage
  cloudBucket   String? // Bucket name for cloud storage
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt   DateTime?
  
  // Relations
  uploader    User @relation(fields: [uploadedBy], references: [id])

  @@map("files")
}

model EmailTemplate {
  id          String @id @default(cuid())
  name        String @unique
  subject     String
  subjectUk   String
  subjectRu   String
  htmlContent String
  htmlContentUk String
  htmlContentRu String
  textContent String?
  textContentUk String?
  textContentRu String?
  
  // Template variables
  variables   String // JSON array of variable names
  
  // Settings
  isActive    Boolean @default(true)
  
  // Metadata
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("email_templates")
}

model SMSTemplate {
  id          String @id @default(cuid())
  name        String @unique
  content     String
  contentUk   String
  contentRu   String
  
  // Template variables
  variables   String // JSON array of variable names
  
  // Settings
  isActive    Boolean @default(true)
  
  // Metadata
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("sms_templates")
}

model PromoCode {
  id            String @id @default(cuid())
  code          String @unique
  name          String
  description   String?
  
  // Discount details
  discountType  String // PERCENTAGE, FIXED_AMOUNT
  discountValue Float
  maxDiscount   Float?
  minOrderAmount Float?
  
  // Usage limits
  maxUses       Int?
  maxUsesPerUser Int @default(1)
  usedCount     Int @default(0)
  
  // Validity
  validFrom     DateTime
  validUntil    DateTime
  
  // Restrictions
  applicableFor String? // JSON array of service categories or specialist IDs
  
  // Settings
  isActive      Boolean @default(true)
  
  // Metadata
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relations
  bookings      Booking[]

  @@map("promo_codes")
}

model FAQ {
  id          String @id @default(cuid())
  question    String
  questionUk  String
  questionRu  String
  answer      String
  answerUk    String
  answerRu    String
  
  // Categorization
  category    String
  tags        String? // JSON array
  
  // Settings
  isActive    Boolean @default(true)
  sortOrder   Int @default(0)
  
  // Metadata
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("faqs")
}

model Report {
  id          String @id @default(cuid())
  reporterId  String
  reportedId  String
  entityType  String // USER, SERVICE, REVIEW
  entityId    String
  
  // Report details
  reason      String
  description String?
  
  // Status
  status      String @default("PENDING") // PENDING, REVIEWING, RESOLVED, DISMISSED
  resolution  String?
  resolvedBy  String?
  resolvedAt  DateTime?
  
  // Metadata
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  reporter    User @relation("ReportsMade", fields: [reporterId], references: [id])
  reported    User @relation("ReportsReceived", fields: [reportedId], references: [id])

  @@map("reports")
}

model PaymentMethod {
  id          String @id @default(cuid())
  userId      String
  
  // Payment method details
  type        String // CARD, APPLE_PAY, GOOGLE_PAY, BANK_TRANSFER
  cardLast4   String?
  cardBrand   String? // visa, mastercard, amex, etc.
  cardExpMonth Int?
  cardExpYear Int?
  
  // Stripe customer and payment method IDs
  stripeCustomerId String?
  stripePaymentMethodId String?
  
  // Display info
  nickname    String?
  isDefault   Boolean @default(false)
  
  // Status
  isActive    Boolean @default(true)
  
  // Metadata
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  user        User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isActive])
  @@index([stripeCustomerId])
  @@map("payment_methods")
}

model FavoriteSpecialist {
  id           String @id @default(cuid())
  userId       String
  specialistId String
  
  // Timestamps
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  // Relations
  user         User @relation("UserFavoriteSpecialists", fields: [userId], references: [id], onDelete: Cascade)
  specialist   Specialist @relation("SpecialistFavorites", fields: [specialistId], references: [id], onDelete: Cascade)
  
  // Constraints
  @@unique([userId, specialistId])
  @@index([userId])
  @@index([specialistId])
  @@map("favorite_specialists")
}

model FavoriteService {
  id        String @id @default(cuid())
  userId    String
  serviceId String
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  user      User @relation("UserFavoriteServices", fields: [userId], references: [id], onDelete: Cascade)
  service   Service @relation("ServiceFavorites", fields: [serviceId], references: [id], onDelete: Cascade)
  
  // Constraints
  @@unique([userId, serviceId])
  @@index([userId])
  @@index([serviceId])
  @@map("favorite_services")
}

model ProfileView {
  id          String @id @default(cuid())
  viewerId    String?  // null for anonymous views
  specialistId String  // whose profile was viewed
  
  // View details
  ipAddress   String?
  userAgent   String?
  referrer    String?
  
  // Session tracking (to avoid counting same user multiple times in short period)
  sessionId   String?
  
  // Timestamps
  createdAt   DateTime @default(now())
  
  // Relations
  viewer      User? @relation("ProfileViewer", fields: [viewerId], references: [id], onDelete: SetNull)
  specialist  User @relation("ProfileViewed", fields: [specialistId], references: [id], onDelete: Cascade)
  
  // Indexes
  @@index([specialistId, createdAt])
  @@index([viewerId])
  @@index([ipAddress, createdAt])
  @@map("profile_views")
}

model TelegramSession {
  id           String @id @default(cuid())
  userId       String
  telegramId   String @unique
  chatId       String?
  platform     String // 'bot' or 'miniapp'
  
  // Session status
  isActive     Boolean @default(true)
  lastActivity DateTime @default(now())
  
  // Timestamps
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  // Relations
  user         User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([telegramId])
  @@index([platform])
  @@map("telegram_sessions")
}

model PlatformAnalytics {
  id          String @id @default(cuid())
  date        DateTime
  platform    String
  
  // Metrics
  activeUsers Int @default(0)
  newUsers    Int @default(0)
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([date, platform])
  @@index([date])
  @@index([platform])
  @@map("platform_analytics")
}

// Enhanced Loyalty Program Models

model LoyaltyTier {
  id          String @id @default(cuid())
  name        String @unique // SILVER, GOLD, PLATINUM
  minPoints   Int
  maxPoints   Int?
  color       String
  icon        String
  benefits    String // JSON array of benefits
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  users       User[] @relation("UserLoyaltyTier")
  
  @@map("loyalty_tiers")
}

model UserBadge {
  id       String @id @default(cuid())
  userId   String
  badgeId  String
  
  // Badge metadata
  earnedAt DateTime @default(now())
  progress Float?   // Progress towards badge if applicable (0.0-1.0)
  
  // Relations
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  badge    Badge  @relation(fields: [badgeId], references: [id], onDelete: Cascade)
  
  @@unique([userId, badgeId])
  @@map("user_badges")
}

model Badge {
  id          String @id @default(cuid())
  name        String @unique
  description String
  icon        String
  color       String
  category    String // BOOKING, REVIEW, REFERRAL, LOYALTY
  
  // Badge criteria (JSON)
  criteria    String
  rarity      String @default("COMMON") // COMMON, RARE, EPIC, LEGENDARY
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  userBadges  UserBadge[]
  
  @@map("badges")
}

model LoyaltyReferral {
  id            String @id @default(cuid())
  referrerId    String
  referredId    String?
  referralCode  String @unique
  
  // Referral status
  status        String @default("PENDING") // PENDING, COMPLETED, EXPIRED
  completedAt   DateTime?
  
  // Points tracking
  referrerPoints    Int @default(0)
  referredPoints    Int @default(0)
  pointsAwarded     Boolean @default(false)
  
  // Metadata
  inviteChannel     String? // EMAIL, SMS, SOCIAL, DIRECT
  firstBookingId    String? // First booking that completed the referral
  
  // Timestamps
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  expiresAt     DateTime
  
  // Relations
  referrer      User     @relation("ReferrerRelation", fields: [referrerId], references: [id], onDelete: Cascade)
  referred      User?    @relation("ReferredRelation", fields: [referredId], references: [id], onDelete: Cascade)
  
  @@index([referralCode])
  @@index([referrerId])
  @@map("loyalty_referrals")
}

model LoyaltyCampaign {
  id                String @id @default(cuid())
  name              String
  description       String
  type              String // DOUBLE_POINTS, BONUS_REVIEW, SEASONAL, SPECIALIST_MULTIPLIER
  
  // Campaign rules (JSON)
  rules             String
  multiplier        Float @default(1.0)
  bonusPoints       Int @default(0)
  
  // Targeting
  targetUserType    String? // CUSTOMER, SPECIALIST, ALL
  targetTiers       String? // JSON array of tier names
  specialistIds     String? // JSON array for specialist-specific campaigns
  
  // Status
  isActive          Boolean @default(true)
  
  // Time bounds
  startsAt          DateTime
  endsAt            DateTime
  
  // Usage limits
  maxRedemptions    Int?
  currentRedemptions Int @default(0)
  maxPerUser        Int @default(1)
  
  // Timestamps
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  redemptions       CampaignRedemption[]
  
  @@index([isActive, startsAt, endsAt])
  @@map("loyalty_campaigns")
}

model CampaignRedemption {
  id          String @id @default(cuid())
  campaignId  String
  userId      String
  
  // Redemption details
  pointsEarned    Int
  referenceId     String? // Booking ID, Review ID, etc.
  referenceType   String? // BOOKING, REVIEW, REFERRAL
  
  // Timestamps
  createdAt   DateTime @default(now())
  
  // Relations
  campaign    LoyaltyCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  user        User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([campaignId, userId, referenceId])
  @@index([userId])
  @@map("campaign_redemptions")
}

model PointsRedemption {
  id              String @id @default(cuid())
  userId          String
  
  // Redemption details
  type            String // DISCOUNT, PAYMENT, PERK
  pointsUsed      Int
  discountPercent Float?
  cashValue       Float? // For partial payments
  
  // Service/booking reference
  bookingId       String?
  serviceId       String?
  specialistId    String?
  
  // Status
  status          String @default("COMPLETED") // COMPLETED, REFUNDED, CANCELLED
  
  // Metadata
  description     String
  originalAmount  Float?
  finalAmount     Float?
  
  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  user            User @relation(fields: [userId], references: [id], onDelete: Cascade)
  booking         Booking? @relation(fields: [bookingId], references: [id])
  
  @@index([userId])
  @@index([bookingId])
  @@map("points_redemptions")
}

model ReviewReward {
  id            String @id @default(cuid())
  userId        String
  reviewId      String?
  bookingId     String
  
  // Reward details
  pointsEarned  Int
  rewardType    String // RATING_ONLY, WITH_COMMENT, WITH_PHOTO
  monthYear     String // YYYY-MM for monthly cap tracking
  
  // Verification
  verified      Boolean @default(false)
  verifiedAt    DateTime?
  
  // Timestamps
  createdAt     DateTime @default(now())
  
  // Relations
  user          User @relation(fields: [userId], references: [id], onDelete: Cascade)
  booking       Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  
  @@unique([userId, bookingId]) // One reward per booking
  @@index([userId, monthYear])
  @@map("review_rewards")
}

model LoyaltyReward {
  id              String @id @default(cuid())
  specialistId    String

  // Reward details
  title           String
  description     String
  type            String // DISCOUNT_VOUCHER, SERVICE_CREDIT, FREE_SERVICE, PERCENTAGE_OFF

  // Reward value
  pointsRequired  Int
  discountPercent Float? // For percentage-based discounts
  discountAmount  Float? // For fixed amount discounts
  serviceIds      String? // JSON array of applicable service IDs (null = all services)

  // Usage limits
  maxRedemptions  Int? // null = unlimited
  currentRedemptions Int @default(0)
  usageLimit      String @default("UNLIMITED") // UNLIMITED, ONCE_PER_USER, LIMITED_TOTAL

  // Availability
  isActive        Boolean @default(true)
  validFrom       DateTime @default(now())
  validUntil      DateTime?

  // Terms and conditions
  termsConditions String?
  minimumTier     String? // Minimum loyalty tier required (BRONZE, SILVER, GOLD, PLATINUM)

  // Metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  specialist      User @relation("SpecialistRewards", fields: [specialistId], references: [id], onDelete: Cascade)
  redemptions     RewardRedemption[]

  @@index([specialistId, isActive])
  @@index([isActive, validFrom, validUntil])
  @@map("loyalty_rewards")
}

model RewardRedemption {
  id              String @id @default(cuid())
  rewardId        String
  userId          String
  bookingId       String?

  // Redemption details
  status          String @default("PENDING") // PENDING, APPROVED, USED, EXPIRED, CANCELLED
  pointsUsed      Int
  discountApplied Float?
  originalAmount  Float?
  finalAmount     Float?

  // Usage tracking
  redeemedAt      DateTime @default(now())
  usedAt          DateTime?
  expiresAt       DateTime?

  // Metadata
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  reward          LoyaltyReward @relation(fields: [rewardId], references: [id], onDelete: Cascade)
  user            User @relation("UserRewardRedemptions", fields: [userId], references: [id], onDelete: Cascade)
  booking         Booking? @relation("BookingRewardRedemptions", fields: [bookingId], references: [id], onDelete: SetNull)

  @@index([userId, status])
  @@index([rewardId, status])
  @@index([status, expiresAt])
  @@map("reward_redemptions")
}

// Crypto Payment Models

model CryptoPayment {
  id              String @id @default(cuid())
  userId          String
  bookingId       String?

  // Coinbase Commerce details
  coinbaseChargeId    String @unique
  coinbaseChargeCode  String? // Short code for the payment

  // Payment details
  status          String // PENDING, PAID, FAILED, EXPIRED, CANCELLED, REFUNDED
  type            String // DEPOSIT, SUBSCRIPTION
  amount          Float
  currency        String @default("USD")

  // Crypto details
  cryptoAmount    Float?
  cryptoCurrency  String? // BTC, ETH, USDC, etc.
  exchangeRate    Float? // USD to crypto rate at time of payment

  // Payment URLs and QR codes
  paymentUrl      String
  qrCodeUrl       String?

  // Webhook data
  webhookData     String? // JSON string of webhook payload
  confirmedAt     DateTime?
  expiresAt       DateTime?

  // Metadata
  metadata        String? // JSON string
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  user            User @relation(fields: [userId], references: [id])
  booking         Booking? @relation(fields: [bookingId], references: [id])

  @@index([userId, status])
  @@index([coinbaseChargeId])
  @@index([status, expiresAt])
  @@map("crypto_payments")
}

model WalletTransaction {
  id              String @id @default(cuid())
  userId          String
  bookingId       String?

  // Transaction details
  type            String // CREDIT, DEBIT, REFUND, FORFEITURE_SPLIT
  amount          Float
  currency        String @default("USD")
  balanceBefore   Float
  balanceAfter    Float

  // Transaction context
  reason          String // DEPOSIT_REFUND, CANCELLATION_CREDIT, BOOKING_PAYMENT, etc.
  description     String?
  referenceId     String? // Related payment, booking, etc.
  referenceType   String? // BOOKING, CRYPTO_PAYMENT, CANCELLATION

  // Status
  status          String @default("COMPLETED") // PENDING, COMPLETED, FAILED
  processedAt     DateTime?

  // Metadata
  metadata        String? // JSON string
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  user            User @relation(fields: [userId], references: [id])
  booking         Booking? @relation(fields: [bookingId], references: [id])

  @@index([userId, type])
  @@index([userId, createdAt])
  @@index([status])
  @@map("wallet_transactions")
}

model SpecialistSubscription {
  id                    String @id @default(cuid())
  specialistId          String

  // Subscription details
  planType              String // PAY_PER_USE, MONTHLY_SUBSCRIPTION
  status                String @default("ACTIVE") // ACTIVE, CANCELLED, EXPIRED, PENDING

  // Billing
  monthlyRate           Float @default(10.0) // $10/month
  currency              String @default("USD")
  transactionFee        Float @default(20.0) // 20â‚´ per transaction for pay-per-use

  // Coinbase Commerce subscription (if applicable)
  coinbaseSubscriptionId String?

  // Billing cycle
  currentPeriodStart    DateTime?
  currentPeriodEnd      DateTime?
  nextBillingDate       DateTime?

  // Plan change management
  pendingPlanType       String? // For plan changes that take effect next month
  planChangeEffectiveDate DateTime?

  // Usage tracking (for pay-per-use)
  currentMonthTransactions Int @default(0)
  currentMonthFees      Float @default(0.0)

  // Payment tracking
  lastPaymentDate       DateTime?
  lastPaymentAmount     Float?
  paymentFailures       Int @default(0)

  // Metadata
  metadata              String? // JSON string
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // Relations
  specialist            User @relation(fields: [specialistId], references: [id])

  @@index([specialistId, status])
  @@index([planType, status])
  @@index([nextBillingDate])
  @@map("specialist_subscriptions")
}

model PaymentWebhook {
  id              String @id @default(cuid())

  // Webhook details
  provider        String // COINBASE_COMMERCE
  eventType       String // charge:confirmed, charge:failed, etc.
  eventId         String @unique

  // Processing status
  status          String @default("PENDING") // PENDING, PROCESSED, FAILED, IGNORED
  processedAt     DateTime?
  errorMessage    String?

  // Webhook data
  payload         String // JSON string of full webhook payload
  signature       String? // Webhook signature for verification

  // Related entities
  relatedId       String? // CryptoPayment ID, Booking ID, etc.
  relatedType     String? // CRYPTO_PAYMENT, SUBSCRIPTION

  // Metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([provider, eventType])
  @@index([status, createdAt])
  @@index([eventId])
  @@map("payment_webhooks")
}

// Coinbase Onramp Sessions for fiat-to-crypto conversion
model OnrampSession {
  id                String @id @default(cuid())

  // User information
  userId            String
  user              User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Session details
  sessionToken      String @unique
  status            String @default("PENDING") // PENDING, COMPLETED, FAILED, EXPIRED

  // Payment amounts
  amount            Float // Fiat amount
  currency          String @default("USD") // Fiat currency
  cryptoAmount      Float? // Actual crypto received
  cryptoCurrency    String? // USDC, ETH, BTC, etc.
  blockchain        String? // ethereum, base, bitcoin, etc.

  // Transaction details
  transactionHash   String? // Blockchain transaction hash
  onrampURL         String // URL for the onramp widget

  // Purpose and related entities
  purpose           String // BOOKING_DEPOSIT, WALLET_TOPUP, SUBSCRIPTION
  bookingId         String? // If for booking deposit
  booking           Booking? @relation(fields: [bookingId], references: [id], onDelete: SetNull)

  // Timing
  expiresAt         DateTime
  completedAt       DateTime?

  // Metadata
  metadata          String? // JSON string for additional data

  // Timestamps
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([userId, status])
  @@index([status, expiresAt])
  @@index([sessionToken])
  @@index([purpose, status])
  @@map("onramp_sessions")
}